<!DOCTYPE html><html lang="en" data-astro-cid-u5v2rru7> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="sitemap" href="/sitemap-index.xml"><link rel="alternate" type="application/rss+xml" title="Mykola on Web" href="https://mgurov.github.io/rss.xml"><meta name="generator" content="Astro v5.15.3"><!-- Font preloads --><link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://mgurov.github.io/notes/0004-programmatic-spring-transactional/"><!-- Primary Meta Tags --><title>Spring @Transactional programmatically</title><meta name="title" content="Spring @Transactional programmatically"><meta name="description" content="When need to think out of the @Transactional box"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://mgurov.github.io/notes/0004-programmatic-spring-transactional/"><meta property="og:title" content="Spring @Transactional programmatically"><meta property="og:description" content="When need to think out of the @Transactional box"><meta property="og:image" content="https://mgurov.github.io/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://mgurov.github.io/notes/0004-programmatic-spring-transactional/"><meta property="twitter:title" content="Spring @Transactional programmatically"><meta property="twitter:description" content="When need to think out of the @Transactional box"><meta property="twitter:image" content="https://mgurov.github.io/blog-placeholder-1.jpg"><style>:root{--accent: #2337ff;--accent-dark: #000d8a;--black: 15, 18, 25;--gray: 96, 115, 159;--gray-light: 229, 233, 240;--gray-dark: 34, 41, 57;--gray-gradient: rgba(var(--gray-light), 50%), #fff;--box-shadow: 0 2px 6px rgba(var(--gray), 25%), 0 8px 24px rgba(var(--gray), 33%), 0 16px 32px rgba(var(--gray), 33%)}@font-face{font-family:Atkinson;src:url(/fonts/atkinson-regular.woff) format("woff");font-weight:400;font-style:normal;font-display:swap}@font-face{font-family:Atkinson;src:url(/fonts/atkinson-bold.woff) format("woff");font-weight:700;font-style:normal;font-display:swap}body{font-family:Atkinson,sans-serif;margin:0;padding:0;text-align:left;background:linear-gradient(var(--gray-gradient)) no-repeat;background-size:100% 600px;word-wrap:break-word;overflow-wrap:break-word;color:rgb(var(--gray-dark));font-size:20px;line-height:1.7}main{width:720px;max-width:calc(100% - 2em);margin:auto;padding:3em 1em}h1,h2,h3,h4,h5,h6{margin:0 0 .5rem;color:rgb(var(--black));line-height:1.2}h1{font-size:3.052em}h2{font-size:2.441em}h3{font-size:1.953em}h4{font-size:1.563em}h5{font-size:1.25em}strong,b{font-weight:700}a,a:hover{color:var(--accent)}p{margin-bottom:1em;text-align:justify}.prose p{margin-bottom:2em;margin-block-end:0}textarea{width:100%;font-size:16px}input{font-size:16px}table{width:100%}img{max-width:100%;height:auto;border-radius:8px}code{padding:2px 5px;background-color:rgb(var(--gray-light));border-radius:2px}pre{padding:1.5em;border-radius:8px}pre>code{all:unset}blockquote{border-left:4px solid var(--accent);padding:0 0 0 20px;margin:0;font-size:1.333em}hr{border:none;border-top:1px solid rgb(var(--gray-light))}@media (max-width: 720px){body{font-size:18px}main{padding:1em}}.sr-only{border:0;padding:0;margin:0;position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px 1px 1px 1px);clip:rect(1px,1px,1px,1px);clip-path:inset(50%);white-space:nowrap}.print-only{display:none}@media print{.no-print{display:none}.print-only{display:inline}a{text-decoration:none;color:#000}}a[data-astro-cid-eimmu3lg]{display:inline-block;text-decoration:none}a[data-astro-cid-eimmu3lg].active{font-weight:bolder;text-decoration:underline}header[data-astro-cid-3ef6ksr2]{margin:0;padding:0 1em;background:#fff;box-shadow:0 2px 8px rgba(var(--black),5%)}h2[data-astro-cid-3ef6ksr2]{margin:0;font-size:1em}h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2],h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none}nav[data-astro-cid-3ef6ksr2]{display:flex;align-items:center;justify-content:space-between}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{padding:1em .5em;color:var(--black);border-bottom:4px solid transparent;text-decoration:none}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none;border-bottom-color:var(--accent)}.social-links[data-astro-cid-3ef6ksr2],.social-links[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{display:flex}@media (max-width: 720px){.social-links[data-astro-cid-3ef6ksr2]{display:none}}@media print{header[data-astro-cid-3ef6ksr2]{display:none}}footer[data-astro-cid-sz7xmlte]{padding:2em 1em 6em;background:linear-gradient(var(--gray-gradient)) no-repeat;color:rgb(var(--gray));text-align:center}.social-links[data-astro-cid-sz7xmlte]{display:flex;justify-content:center;gap:1em;margin-top:1em}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]{text-decoration:none;color:rgb(var(--gray))}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]:hover{color:rgb(var(--gray-dark))}@media print{footer[data-astro-cid-sz7xmlte]{display:none}}
main[data-astro-cid-u5v2rru7]{width:calc(100% - 2em);max-width:100%;margin:0}.hero-image[data-astro-cid-u5v2rru7]{width:100%}.hero-image[data-astro-cid-u5v2rru7] img[data-astro-cid-u5v2rru7]{display:block;margin:0 auto;border-radius:12px;box-shadow:var(--box-shadow)}.prose[data-astro-cid-u5v2rru7]{width:720px;max-width:calc(100% - 2em);margin:auto;padding:1em;color:rgb(var(--gray-dark))}.title[data-astro-cid-u5v2rru7]{margin-bottom:1em;padding:1em 0;text-align:center;line-height:1}.title[data-astro-cid-u5v2rru7] h1[data-astro-cid-u5v2rru7]{margin:0 0 .5em}.date[data-astro-cid-u5v2rru7]{margin-bottom:.5em;color:rgb(var(--gray))}.last-updated-on[data-astro-cid-u5v2rru7]{font-style:italic}@media print{main[data-astro-cid-u5v2rru7]{font-size:18px}}
</style></head> <body data-astro-cid-u5v2rru7> <header data-astro-cid-3ef6ksr2> <nav data-astro-cid-3ef6ksr2> <h2 data-astro-cid-3ef6ksr2><a href="/" data-astro-cid-3ef6ksr2>Mykola on Web</a></h2> <div class="internal-links" data-astro-cid-3ef6ksr2> <a href="/about" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> About Me </a>  <a href="/talks" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Talks </a>  <a href="/notes" class="active" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Notes </a>  </div> <div class="social-links" data-astro-cid-3ef6ksr2> <a href="https://www.linkedin.com/in/mgurov" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>My LinkedIn mgurov</span> <svg viewBox="0 0 65 65" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" data-astro-cid-3ef6ksr2></path></svg> </a> <a href="https://bsky.app/profile/did:plc:dc3koajj5tardwrjv5pf72sy" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Talk to me on BlueSky</span> <svg viewBox="0 0 568 501" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M123.121 33.664C188.241 82.553 258.281 181.68 284 234.873c25.719-53.192 95.759-152.32 160.879-201.21C491.866-1.611 568-28.906 568 57.947c0 17.346-9.945 145.713-15.778 166.555-20.275 72.453-94.155 90.933-159.875 79.748C507.222 323.8 536.444 388.56 473.333 453.32c-119.86 122.992-172.272-30.859-185.702-70.281-2.462-7.227-3.614-10.608-3.631-7.733-.017-2.875-1.169.506-3.631 7.733-13.43 39.422-65.842 193.273-185.702 70.281-63.111-64.76-33.89-129.52 80.986-149.071-65.72 11.185-139.6-7.295-159.875-79.748C9.945 203.659 0 75.291 0 57.946 0-28.906 76.135-1.612 123.121 33.664Z" data-astro-cid-3ef6ksr2></path></svg> </a> <a href="https://github.com/mgurov" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>My GitHub presence</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-3ef6ksr2></path></svg> </a> </div> </nav> </header>  <main data-astro-cid-u5v2rru7> <article data-astro-cid-u5v2rru7> <div class="hero-image" data-astro-cid-u5v2rru7>   </div> <div class="prose" data-astro-cid-u5v2rru7> <div class="title" data-astro-cid-u5v2rru7> <h1 data-testid="page-title" data-astro-cid-u5v2rru7> Spring @Transactional programmatically </h1> <hr data-astro-cid-u5v2rru7> </div>  <p>An an enterprise developer, it’s easy to get used to the conveniences of Spring (Boot) so much that it becomes an issue on itself. Take <code>@Transactional</code>. Arguably, one of the few core features of Spring that does make us more productive in development. But at times it can be slightly inconvenient to rely solely on annotation for transaction boundary setup:</p>
<ul>
<li>It might not be desireable to have a database transaction open throughout the whole request processing, e.g if we do external calls to collect more data, thus introducing latencies that might deplete our db connection pool.</li>
<li>It might also be inconvenient and clumsy to set the transactional boundaries exactly at the methods, in particular when it ought to be accessed via proxy only (TODO: a link to the details).</li>
</ul>
<p>The simplest approach to overcome this inconvenience is to introduce a simple transactional helper:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="java"><code><span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">Component</span></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> Transactionally</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">  @</span><span style="color:#F97583">Transactional</span></span>
<span class="line"><span style="color:#F97583">  public</span><span style="color:#E1E4E8"> &#x3C;</span><span style="color:#F97583">T</span><span style="color:#E1E4E8">> T </span><span style="color:#B392F0">run</span><span style="color:#E1E4E8">(Supplier&#x3C;</span><span style="color:#F97583">T</span><span style="color:#E1E4E8">> </span><span style="color:#FFAB70">block</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#E1E4E8"> block.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>And inject it as yet another Spring dependency:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="java"><code><span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">Inject</span></span>
<span class="line"><span style="color:#F97583">private</span><span style="color:#E1E4E8"> Transactionally transactionally;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> doSomething</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    ....</span></span>
<span class="line"><span style="color:#F97583">    var</span><span style="color:#E1E4E8"> transactionalResult </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> transactionally.</span><span style="color:#B392F0">run</span><span style="color:#E1E4E8">(() </span><span style="color:#F97583">-></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        ...</span></span>
<span class="line"><span style="color:#E1E4E8">    });</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>A slightly more evolved, flexible and convenient in a longer run approach might be to follow the advice of the <a href="https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/data-access.html#transaction-programmatic">Spring’s documentation on programmatic transactions</a> and use <code>TransactionTemplate</code>:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="kotlin"><code><span class="line"><span style="color:#B392F0">@Component</span></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> Transactionally</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">    transactionManager: </span><span style="color:#B392F0">PlatformTransactionManager</span><span style="color:#6A737D"> // injected</span></span>
<span class="line"><span style="color:#E1E4E8">    ) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> val</span><span style="color:#E1E4E8"> transactionTemplate </span><span style="color:#F97583">=</span><span style="color:#B392F0"> TransactionTemplate</span><span style="color:#E1E4E8">(transactionManager)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    operator</span><span style="color:#F97583"> fun</span><span style="color:#E1E4E8"> &#x3C;</span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">> </span><span style="color:#B392F0">invoke</span><span style="color:#E1E4E8">(block: ()</span><span style="color:#F97583">-></span><span style="color:#E1E4E8">T): </span><span style="color:#B392F0">T</span><span style="color:#E1E4E8">? {</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> transactionTemplate.</span><span style="color:#B392F0">execute</span><span style="color:#E1E4E8"> {</span><span style="color:#B392F0">block</span><span style="color:#E1E4E8">()}</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> SomeService</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">private</span><span style="color:#F97583"> val</span><span style="color:#E1E4E8"> transactionally: </span><span style="color:#B392F0">Transactionally</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    fun</span><span style="color:#B392F0"> something</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        ..</span><span style="color:#E1E4E8">.</span></span>
<span class="line"><span style="color:#F97583">        val</span><span style="color:#E1E4E8"> transactionalResult </span><span style="color:#F97583">=</span><span style="color:#B392F0"> transactionally</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">            //do transactional stuff</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#6A737D">        // the transaction is over</span></span>
<span class="line"><span style="color:#F97583">        ..</span><span style="color:#E1E4E8">.</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"><span style="color:#6A737D">//TODO: check nullability of kotlin params</span></span>
<span class="line"><span style="color:#6A737D">//TODO: nicer block passing to the template?</span></span></code></pre>
<p>TODO: Testing reasons.</p>
<h4 id="links--references">Links &#x26; References</h4>
<p>Spring’s documentation: <a href="https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/data-access.html#transaction-declarative-annotations">Declarative Annotations</a>, <a href="https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/data-access.html#transaction-programmatic">Programmatic transactions</a></p>  <div class="date" data-astro-cid-u5v2rru7> 
Since <time datetime="2020-01-12T18:02:56.000Z"> Jan 12, 2020 </time>   </div> </div> </article> </main> <footer data-astro-cid-sz7xmlte> <div class="social-links" data-astro-cid-sz7xmlte> <a href="https://www.linkedin.com/in/mgurov" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>My LinkedIn mgurov</span> <svg viewBox="0 0 65 65" aria-hidden="true" width="32" height="32" data-astro-cid-sz7xmlte><path fill="currentColor" d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" data-astro-cid-sz7xmlte></path></svg> </a> <a href="https://bsky.app/profile/did:plc:dc3koajj5tardwrjv5pf72sy" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Talk to me on BlueSky</span> <svg viewBox="0 0 568 501" aria-hidden="true" width="32" height="32" data-astro-cid-sz7xmlte><path fill="currentColor" d="M123.121 33.664C188.241 82.553 258.281 181.68 284 234.873c25.719-53.192 95.759-152.32 160.879-201.21C491.866-1.611 568-28.906 568 57.947c0 17.346-9.945 145.713-15.778 166.555-20.275 72.453-94.155 90.933-159.875 79.748C507.222 323.8 536.444 388.56 473.333 453.32c-119.86 122.992-172.272-30.859-185.702-70.281-2.462-7.227-3.614-10.608-3.631-7.733-.017-2.875-1.169.506-3.631 7.733-13.43 39.422-65.842 193.273-185.702 70.281-63.111-64.76-33.89-129.52 80.986-149.071-65.72 11.185-139.6-7.295-159.875-79.748C9.945 203.659 0 75.291 0 57.946 0-28.906 76.135-1.612 123.121 33.664Z" data-astro-cid-sz7xmlte></path></svg> </a> <a href="https://github.com/mgurov" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>My GitHub presence</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-sz7xmlte><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-sz7xmlte></path></svg> </a> </div> </footer>   <script type="module" src="/_astro/GenericPost.astro_astro_type_script_index_1_lang.1Loum7wa.js"></script> </body></html>